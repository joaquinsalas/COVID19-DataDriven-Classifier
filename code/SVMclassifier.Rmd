---
title: 'SVM classifier'
author: "joaquin salas"
date: "2020.06.26"
output:
  pdf_document: default
  word_document: default
  
  #data saved in: "featureSelection.RData"
  #save(list = ls(all.names=TRUE), file = "featureSelection.RData")
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Given that a patient has been confirmed positive, 
this program construct an SVM classifier to infer whether the patient 
will improve or will die.
To assess the classifier, we construct ROC and precision-recall curves.



```{r  echo=FALSE}




#import libraries
suppressMessages(library(caret))
suppressMessages(library(caTools))

suppressMessages(library(data.table)) # setnames

suppressMessages(require(dplyr))

suppressMessages(require(dummies)) #dummy variables
suppressMessages(require(ggplot2))
suppressMessages(require("Hmisc"))
suppressMessages(library("installr"))
suppressMessages(library(lubridate, warn.conflict = FALSE, quietly = TRUE))
suppressMessages(library(missForest)) #missForest
suppressMessages(library(matrixStats)) #colSds, standard deviation

suppressMessages(require(multiROC))
suppressMessages(require(nbpMatching))

suppressMessages(require(plotly))
suppressMessages(require(PRROC))
suppressMessages(library(pROC,verbose = TRUE )) #pROC, ROC analysis
suppressMessages(require(plyr))

suppressMessages(suppressWarnings(library(randomForest))) #for randomForest
suppressMessages(library(readr))

suppressMessages(library(stringi))

suppressMessages(library(tidyr)) #fill


suppressMessages(library(e1071))

suppressMessages(library(kernlab)) #svm



source("readDataSVM.R")




```


## Read the data

Dado que utilizaremos Boruta para la seleccion de caracteristicas, reducimos la base de datos mediante la siguiente estrategia. 


```{r preparacion, echo=FALSE}


#working directories
code.dir = 'your-code-directory'
setwd(code.dir)

#directories with files that  I use across many applications related to COVID
data.dir = 'your-data-directory'



#files in the data.dir directory corresponding to the Health Ministery data
files.pattern = "file-name-pattern.csv"

files <- list.files(path = data.dir, pattern =  files.pattern)

#############

i = 1
for (file in files) {
  
  filename = paste(data.dir, file, sep = "")
  
  dataset = readDataSVM(filename = filename)
  
  if (i == 1) {
    data = dataset
  }
  else {
    data = rbind(data, dataset)
  }
  i = i + 1
}








covid = data[data$DIAGNOSTICO_FINAL == "COVID-19",!(names(data) %in% c("DIAGNOSTICO_FINAL"))]
condicion.medica = (covid$DESC_MOTIVO_EGRESO == "MEJORIA") | 
  (covid$DESC_MOTIVO_EGRESO == "DEFUNCION")

covid.diag = covid[condicion.medica,]

threshold.nan = 0 # the current database is full

covid.diag.pred = covid.diag[, !(names(covid.diag) %in% c("DESC_MOTIVO_EGRESO"))]

#change predictor from factor <MEJORIA, DEFUNCION> to factor <0,1>
pred = covid.diag$DESC_MOTIVO_EGRESO
pred.num = c(0,nrow=length(pred), ncol= 1)
pred.num[pred==c("MEJORIA")] = 0
pred.num[pred==c("DEFUNCION")] = 1


pred.num = as.factor(pred.num)

too.many.nan = 
  names(covid.diag.pred)[colSums(is.na(covid.diag.pred)) > threshold.nan]


#remove variables for which there are too many missing values
covid.no.nan = covid.diag.pred[, !(names(covid.diag.pred) %in% c(too.many.nan))]




##fill missing values
covid.imp = 
  suppressMessages(suppressWarnings(missForest(covid.no.nan, verbose=FALSE)))

covid.full = covid.imp$ximp

#make sure these variables are factors
for (name in names(covid.full)) {
  if (is.factor(covid.full[,name])) {
    covid.full[,name] = droplevels(covid.full[,name])
    l = levels(droplevels(covid.full[,name]))
    if (length(l) < 2) {
      #drop factor columns with just one level
      covid.full = covid.full[,!(names(covid.full) %in% name)] 
    }
    
  }  
}




#dataset for processing
dataset = list(X = covid.full, y = pred.num) 


dim(dataset$X)


dataset$X$EDAD_ANO = as.numeric(dataset$X$EDAD_ANO)

#convert categorical variables into numeric
Xdummies = dummyVars( "~." , dataset$X)
transf = data.frame(predict(Xdummies, newdata = dataset$X))
dataset$X = transf


#normalize age
print(mean(dataset$X$EDAD_ANO))
print(sd(dataset$X$EDAD_ANO))
dataset$X$EDAD_ANO = scale(dataset$X$EDAD_ANO)





```
## Support Vector Machine Classifier

We built a Support Vector Machine classifier

```{r include=FALSE}

X = dataset$X
y = as.factor(dataset$y)


ndata = cbind(X,y)

names(ndata) = make.names(names(ndata))

#otherwise there will be an error during train
levels(ndata$y)[1]<-"positive"
levels(ndata$y)[2]<-"negative"


#seed for the random numbers generator
set.seed(123)


#perfom cross-validation cv.trial times
cv.trial = 30
#accumulate the results in the ROC and precision-recall curve
roc.auc = matrix(0,1, cv.trial)
pr.auc = matrix(0,1, cv.trial)


#divide subset datain half
smp.size = floor(0.5 * nrow(ndata))


#cross-validation iterations
for (trial in seq(1,cv.trial)) {
  
  print(trial)
  
  
  
  ndata.ind <- createDataPartition(ndata$y, p = 0.5, list = FALSE)
  
  #construct a classifier
  
  
  #there is an issue with train
  #https://github.com/topepo/caret/issues/809
  svm.classifier <- train(
    y ~., data = ndata[ndata.ind,], method = "svmRadial",
    trControl = trainControl("cv", number = 10, classProbs = TRUE),
    preProcess = c("center","scale"),
    tuneLength = 10
  )
  
   
  
  #predict output. This is what you want to implement in an app
  y_pred = predict(svm.classifier,ndata[-ndata.ind,],type = "prob")
  
  #init an array with zeros
  ground.truth = array(0, dim = dim(y_pred)[1] )
  test.set = ndata[-ndata.ind,]$y=="positive"
  ground.truth[test.set] = 1
  
 
  #performance results
  roc<-roc.curve(scores.class0 = y_pred[,1],
                 weights.class0 = ground.truth, curve= TRUE)
  pr<-pr.curve(scores.class0 =  y_pred[,1],
               weights.class0 = ground.truth, curve= TRUE)
  
  
  #save results for analysis
  roc.auc[ trial] = roc$auc
  pr.auc[ trial] = pr$auc.integral
  
  #save results for each classifier
  filename = sprintf("../data/svm_roc_%03d.csv", trial)
  write.csv(roc$curve,filename)
  
  filename = sprintf("../data/svm_pr_%03d.csv", trial)
  write.csv(pr$curve,filename)
  
  
  print(roc$auc)
  print(pr$auc.integral)
  
}









save(list = ls(all.names=TRUE), file = "SVMClassifier.RData")
load(file = "SVMClassifier.RData")

```


